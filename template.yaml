AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  AWS SNS Component


Globals:
  Api:
    TracingEnabled: true
    Cors: # see CORS section
      AllowHeaders: "'*'"
      AllowOrigin: "'*'"

  Function:
    Timeout: 5
    Runtime: python3.9
    Tracing: Active

Resources:

  MessageQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: SNSComponentMessageQueue


  UpdateQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: SNSComponentUpdateQueue

  # 72.83.171.80

  MessageSender:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: SNSComponentMessageSender
      CodeUri: .
      Handler: functions/message-sender/src/app.lambda_handler
      Events:
        NewMessage:
          Type: SQS
          Properties:
            BatchSize: 10
            Enabled: True
            Queue: !GetAtt MessageQueue.Arn

  SNSManager:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: SNSComponentSNSManager
      CodeUri: .
      Handler: functions/sns-manager/src/app.lambda_handler
      Events: 
        ApiEvent:
          Type: Api
          Properties:
            Auth:
              ResourcePolicy:
                IpRangeBlacklist:
                  - "*"
                IpRangeWhitelist:
                  - "72.83.171.80"
            Method: ANY
            Path: /{path+}
  
  UpdateLogger:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: SNSComponentUpdateLogger
      CodeUri: .
      Handler: functions/update-logger/src/app.lambda-handler
      Events:
        NewMessage:
          Type: SQS
          Properties:
            BatchSize: 10
            Enabled: True
            Queue: !GetAtt UpdateQueue.Arn

  #need
  #dynamo
  #sns

  ChangeLog:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: SNSUpdateTable
      BillingMode: PROVISIONED
      ProvisionedThroughput:
        ReadCapacityUnits: 25
        WriteCapacityUnits: 25
      TimeToLiveSpecification:
        Enabled: True
        AttributeName: "ttl"
      KeySchema: 
        - AttributeName: resource_arn
          KeyType: HASH
        - AttributeName: timestamp
          KeyType: RANGE
      AttributeDefinitions:
        - AttributeName: resource_arn
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: S

  






